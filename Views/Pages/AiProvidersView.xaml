<UserControl x:Class="EliteWhisper.Views.Pages.AiProvidersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:EliteWhisper.Views.Pages"
             xmlns:converters="clr-namespace:EliteWhisper.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="800">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:BooleanToVisibilityConverter x:Key="InverseBoolToVis" Invert="True"/>
        <converters:CountToVisibilityConverter x:Key="CountToVis"/>
    </UserControl.Resources>

    <Grid Background="{StaticResource BackgroundPrimary}">
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="32">
                
                <!-- Page Header -->
                <TextBlock Text="AI Providers" Style="{StaticResource HeadingLarge}" Margin="0,0,0,8"/>
                <TextBlock Text="Configure local and cloud AI models for post-processing." Style="{StaticResource BodyText}" Margin="0,0,0,32"/>

                <!-- Local AI (Ollama) -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel>
                                <TextBlock Text="Local AI (Ollama)" Style="{StaticResource HeadingSmall}"/>
                                <TextBlock Text="Run AI post-processing locally on your device." Style="{StaticResource BodyText}" Margin="0,4,0,0"/>
                            </StackPanel>
                        </Grid>

                        <StackPanel Orientation="Horizontal" Margin="0,12,0,16">
                            <!-- Status Indicator -->
                            <Border CornerRadius="6" Padding="8,4" Margin="0,0,12,0" VerticalAlignment="Center">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="{StaticResource BackgroundTertiary}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsOllamaRunning}" Value="True">
                                                <Setter Property="Background" Value="#DCFCE7"/> <!-- Light Green -->
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsOllamaRunning}" Value="False">
                                                <Setter Property="Background" Value="#FEE2E2"/> <!-- Light Red -->
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="8" Height="8" Margin="0,0,6,0">
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Setter Property="Fill" Value="#EF4444"/> <!-- Red -->
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsOllamaRunning}" Value="True">
                                                        <Setter Property="Fill" Value="#10B981"/> <!-- Green -->
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                    </Ellipse>
                                    <TextBlock VerticalAlignment="Center" FontWeight="Medium" FontSize="13">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="Ollama not running"/>
                                                <Setter Property="Foreground" Value="#B91C1C"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsOllamaRunning}" Value="True">
                                                        <Setter Property="Text" Value="Ollama detected"/>
                                                        <Setter Property="Foreground" Value="#15803D"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <Button Content="Test Connection" Command="{Binding CheckOllamaStatusCommand}" Style="{StaticResource SecondaryButton}"/>
                        </StackPanel>

                        <!-- Installed Models -->
                        <Border BorderBrush="{StaticResource BorderPrimary}" BorderThickness="0,1,0,0" Margin="0,8,0,16" Padding="0,16,0,0"
                                Visibility="{Binding IsOllamaRunning, Converter={StaticResource BoolToVis}}">
                            <StackPanel>
                                <TextBlock Text="Installed Models" Style="{StaticResource HeadingSmall}" FontSize="14" Margin="0,0,0,12"/>
                                
                                <ItemsControl ItemsSource="{Binding LocalModels}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource BackgroundSecondary}" CornerRadius="6" Padding="12,8" Margin="0,0,0,8">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <StackPanel VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="{StaticResource TextPrimary}"/>
                                                        <TextBlock Text="{Binding Size}" FontSize="12" Foreground="{StaticResource TextTertiary}"/>
                                                    </StackPanel>
                                                    
                                                    <!-- Delete Button -->
                                                    <Button Grid.Column="2" 
                                                            Command="{Binding DataContext.DeleteModelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource SecondaryButton}" 
                                                            Padding="8,4" Margin="12,0,0,0"
                                                            Background="Transparent" BorderThickness="0">
                                                        <Path Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" 
                                                              Fill="{StaticResource TextTertiary}" Width="14" Height="14"/>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Helper Text -->
                                <TextBlock Text="Start with 'phi3:mini' for speed or 'mistral' for quality." 
                                           Style="{StaticResource CaptionText}" Margin="0,16,0,8"
                                           Visibility="{Binding LocalModels.Count, Converter={StaticResource CountToVis}, ConverterParameter=Invert}"/>

                                <!-- Download Section -->
                                <Grid Margin="0,8,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Text="{Binding NewModelName, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource InputField}" 
                                             Tag="Download model (e.g. phi3:mini)..."
                                             IsEnabled="{Binding IsNotDownloading}"/>
                                    
                                    <Button Grid.Column="1" Content="Pull Model" 
                                            Command="{Binding DownloadModelCommand}" 
                                            Style="{StaticResource PrimaryButtonStyle}" 
                                            Margin="12,0,0,0"
                                            IsEnabled="{Binding IsNotDownloading}"
                                            Visibility="{Binding IsDownloading, Converter={StaticResource InverseBoolToVis}}"/>
                                            
                                    <!-- Busy Indicator equivalent -->
                                    <Button Grid.Column="1" Content="Pulling..." 
                                            Style="{StaticResource SecondaryButton}" 
                                            Margin="12,0,0,0"
                                            IsEnabled="False"
                                            Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}"/>
                                </Grid>
                                
                                <!-- Progress Bar -->
                                <StackPanel Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}" Margin="0,12,0,0">
                                    <Grid Margin="0,0,0,4">
                                        <TextBlock Text="{Binding DownloadStatusText}" FontSize="12" Foreground="{StaticResource TextSecondary}"/>
                                        <TextBlock Text="{Binding DownloadProgress, StringFormat='{}{0}%'}" HorizontalAlignment="Right" FontSize="12" Foreground="{StaticResource TextSecondary}"/>
                                    </Grid>
                                    <ProgressBar Value="{Binding DownloadProgress}" Maximum="100" Height="4" BorderThickness="0" Background="{StaticResource BackgroundTertiary}" Foreground="{StaticResource AccentPrimary}"/>
                                </StackPanel>
                                
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- Cloud AI Providers -->
                <Border Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Cloud AI Providers" Style="{StaticResource HeadingSmall}" Margin="0,0,0,8"/>
                        <TextBlock Text="API keys are stored securely on this device (DPAPI) and never transmitted elsewhere." 
                                   Style="{StaticResource CaptionText}" Margin="0,0,0,16"/>

                        <!-- Gemini -->
                        <StackPanel Margin="0,0,0,24">
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Google Gemini API Key" Style="{StaticResource BodyText}" FontWeight="SemiBold"/>
                                
                                <!-- Configured Status -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <Path Data="{StaticResource IconCheckGeometry}" Fill="#10B981" Width="12" Height="12" Margin="0,0,6,0"
                                          Visibility="{Binding IsGeminiConfigured, Converter={StaticResource BoolToVis}}"/>
                                    <TextBlock FontSize="12">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="Not configured"/>
                                                <Setter Property="Foreground" Value="{StaticResource TextTertiary}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsGeminiConfigured}" Value="True">
                                                        <Setter Property="Text" Value="Configured"/>
                                                        <Setter Property="Foreground" Value="#10B981"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                            
                            <TextBox Text="{Binding GeminiApiKeyInput, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource InputField}" 
                                     Tag="Paste new API key to update..."/>

                            <!-- Gemini Model Status -->
                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Content="Refresh Models" Command="{Binding RefreshGeminiModelsCommand}" 
                                        Style="{StaticResource SecondaryButton}" 
                                        IsEnabled="{Binding IsGeminiConfigured}"
                                        Padding="8,4" Margin="0,0,12,0" FontSize="12"/>
                                
                                <TextBlock Text="{Binding GeminiStatusText}" VerticalAlignment="Center" 
                                           Foreground="{StaticResource TextSecondary}" FontSize="12"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- OpenRouter -->
                        <StackPanel Margin="0,0,0,24">
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="OpenRouter API Key" Style="{StaticResource BodyText}" FontWeight="SemiBold"/>
                                
                                <!-- Configured Status -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <Path Data="{StaticResource IconCheckGeometry}" Fill="#10B981" Width="12" Height="12" Margin="0,0,6,0"
                                          Visibility="{Binding IsOpenRouterConfigured, Converter={StaticResource BoolToVis}}"/>
                                    <TextBlock FontSize="12">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="Not configured"/>
                                                <Setter Property="Foreground" Value="{StaticResource TextTertiary}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsOpenRouterConfigured}" Value="True">
                                                        <Setter Property="Text" Value="Configured"/>
                                                        <Setter Property="Foreground" Value="#10B981"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                            
                            <TextBox Text="{Binding OpenRouterApiKeyInput, UpdateSourceTrigger=PropertyChanged}" 
                                     Style="{StaticResource InputField}" 
                                     Tag="Paste new API key to update..."/>
                        </StackPanel>

                        <Button Content="Save API Keys" Command="{Binding SaveKeysCommand}" 
                                Style="{StaticResource PrimaryButtonStyle}" HorizontalAlignment="Left"/>
                    </StackPanel>
                </Border>

                <!-- Defaults & Fallback -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel>
                        <TextBlock Text="Defaults &amp; Fallback" Style="{StaticResource HeadingSmall}" Margin="0,0,0,8"/>
                        <TextBlock Text="Choose which provider to use by default." Style="{StaticResource BodyText}" Margin="0,0,0,16"/>

                        <StackPanel Margin="0,0,0,12">
                            <TextBlock Text="Default Provider Preference" Style="{StaticResource BodyText}" FontWeight="SemiBold" Margin="0,0,0,8"/>
                            <ComboBox SelectedValue="{Binding DefaultProviderPreference}" 
                                      SelectedValuePath="Tag"
                                      Style="{StaticResource PremiumComboBox}" HorizontalAlignment="Left" Width="250">
                                <ComboBoxItem Content="Auto (Recommended)" Tag="Auto"/>
                                <ComboBoxItem Content="Local (Ollama)" Tag="Ollama"/>
                                <ComboBoxItem Content="Google Gemini" Tag="Gemini"/>
                                <ComboBoxItem Content="OpenRouter" Tag="OpenRouter"/>
                            </ComboBox>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                            <Path Data="{StaticResource IconInfoGeometry}" Fill="{StaticResource TextTertiary}" Width="14" Height="14" Margin="0,2,8,0" VerticalAlignment="Top"/>
                            <TextBlock Style="{StaticResource CaptionText}" TextWrapping="Wrap" MaxWidth="500">
                                <Run Text="Fallback Chain:" FontWeight="SemiBold"/>
                                <Run Text="Local (if available) → Gemini → OpenRouter. Elite Whisper will automatically try the next provider if the preferred one fails."/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
