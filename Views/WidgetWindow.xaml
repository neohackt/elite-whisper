<Window x:Class="EliteWhisper.Views.WidgetWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:models="clr-namespace:EliteWhisper.Models"
        xmlns:controls="clr-namespace:EliteWhisper.Controls"
        Background="Transparent"
        AllowsTransparency="True"
        WindowStyle="None"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        Topmost="True"
        Focusable="False"
        SizeToContent="WidthAndHeight"
        SnapsToDevicePixels="True"
        UseLayoutRounding="True">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Resources/Icons.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters -->
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        
        <!-- Widget Button Style -->
        <Style x:Key="WidgetIconButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                CornerRadius="6"
                                SnapsToDevicePixels="True"
                                UseLayoutRounding="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#33FFFFFF"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.7"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        </ResourceDictionary>
    </Window.Resources>

    <!-- 
    ════════════════════════════════════════════════════════════════════════════
    FLOATING WIDGET - Layered Shadow Architecture (NO DropShadowEffect)
    
    Structure:  Window → Grid → [ShadowBorder (ZIndex=0), ContentBorder (ZIndex=1)]
    Shadow:     Pill-shaped Border behind main content (no effects)
    Modes:      Collapsed → HoverExpanded → Expanded
    ════════════════════════════════════════════════════════════════════════════
    -->
    
    <Grid x:Name="RootContainer">
        <!-- SHADOW LAYER: Pill-shaped, slightly larger, positioned behind -->
        <Border x:Name="ShadowLayer"
                Height="52"
                MinWidth="148"
                CornerRadius="26"
                Background="#40000000"
                Opacity="0.25"
                Margin="0,4,0,0"
                IsHitTestVisible="False"
                Panel.ZIndex="0"
                SnapsToDevicePixels="True"
                UseLayoutRounding="True"/>
        
        <!-- CONTENT LAYER: Main visible surface -->
        <Border x:Name="ContentLayer"
                Height="48"
                MinWidth="140"
                Padding="18,0"
                CornerRadius="24"
                Background="#FF1E1E1E"
                ClipToBounds="True"
                Panel.ZIndex="1"
                SnapsToDevicePixels="True"
                UseLayoutRounding="True">
            
            <Grid>
                <!-- ==================== PILL MODE (Collapsed + HoverExpanded) ==================== -->
                <StackPanel x:Name="PillContent"
                            Orientation="Horizontal" 
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    
                    <!-- State Indicator -->
                    <Grid Width="24" Height="24" Margin="0,0,10,0">
                        
                        <!-- Pulse Ring (Listening only) -->
                        <Ellipse x:Name="PulseRing" 
                                 Width="24" Height="24" 
                                 Fill="#EF4444" 
                                 Opacity="0"
                                 RenderTransformOrigin="0.5,0.5">
                            <Ellipse.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                            </Ellipse.RenderTransform>
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding State}" Value="{x:Static models:WidgetState.Listening}">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard x:Name="PulseStoryboard">
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                                         From="1" To="1.8" Duration="0:0:1" AutoReverse="True"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                                         From="1" To="1.8" Duration="0:0:1" AutoReverse="True"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                         From="0.4" To="0" Duration="0:0:1" AutoReverse="True"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <StopStoryboard BeginStoryboardName="PulseStoryboard"/>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        
                        <!-- Core Dot: 8px circle -->
                        <Ellipse Width="8" Height="8" 
                                 VerticalAlignment="Center" 
                                 HorizontalAlignment="Center">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="#6B7280"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding State}" Value="{x:Static models:WidgetState.Listening}">
                                            <Setter Property="Fill" Value="#EF4444"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding State}" Value="{x:Static models:WidgetState.Processing}">
                                            <Setter Property="Fill" Value="#6366F1"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                    </Grid>
                    
                    <!-- Status Text: Explicitly set Foreground -->
                    <TextBlock Text="{Binding StatusText}" 
                               Foreground="#FFFFFF" 
                               FontSize="14" 
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               FontFamily="Segoe UI Variable Display, Segoe UI"/>
                    
                    <!-- Mini Waveform (5 bars, visible only when listening) -->
                    <controls:WaveformControl 
                        Amplitudes="{Binding MiniAmplitudes}"
                        BarCount="5"
                        BarWidth="2"
                        BarSpacing="3"
                        MaxBarHeight="9"
                        MinBarHeight="1.5"
                        CenterGap="2"
                        BarFill="#4EA1FF"
                        Width="35"
                        Height="22"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        Visibility="{Binding IsListening, Converter={StaticResource BoolToVis}}"/>
                    
                    <!-- Hover Action Buttons (visible only in HoverExpanded) -->
                    <StackPanel x:Name="HoverButtons"
                                Orientation="Horizontal" 
                                Margin="12,0,0,0"
                                Visibility="{Binding IsHoverExpanded, Converter={StaticResource BoolToVis}}">
                        
                        <!-- Change Mode Button (Stub) -->
                        <Button Style="{StaticResource WidgetIconButton}" 
                                ToolTip="Change mode (Ctrl+Shift+M)" 
                                Margin="0,0,4,0">
                            <Path Data="{StaticResource IconGearGeometry}" 
                                  Fill="#FFFFFF" 
                                  Stretch="Uniform" 
                                  Width="14" Height="14"/>
                        </Button>
                        
                        <!-- Record/Stop Button (mirrors hotkey) -->
                        <Button Style="{StaticResource WidgetIconButton}" 
                                ToolTip="{Binding RecordButtonTooltip}"
                                Command="{Binding ToggleRecordingCommand}"
                                Margin="0,0,4,0">
                            <Grid>
                                <!-- Mic icon when not listening -->
                                <Path Data="{StaticResource IconMicrophoneGeometry}" 
                                      Fill="#FFFFFF" 
                                      Stretch="Uniform" 
                                      Width="14" Height="14">
                                    <Path.Style>
                                        <Style TargetType="Path">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsListening}" Value="True">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Path.Style>
                                </Path>
                                <!-- Stop icon when listening -->
                                <Rectangle Width="10" Height="10" 
                                           Fill="#EF4444" 
                                           RadiusX="2" RadiusY="2"
                                           Visibility="{Binding IsListening, Converter={StaticResource BoolToVis}}"/>
                            </Grid>
                        </Button>
                        
                        <!-- Expand Button -->
                        <Button Style="{StaticResource WidgetIconButton}" 
                                ToolTip="Expand window"
                                Command="{Binding ExpandCommand}">
                            <Path Data="M 4 14 L 14 14 L 14 4 M 14 14 L 4 4" 
                                  Stroke="#FFFFFF" 
                                  StrokeThickness="2"
                                  Width="12" Height="12"/>
                        </Button>
                    </StackPanel>
                </StackPanel>
                
                <!-- ==================== EXPANDED MODE ==================== -->
                <Grid x:Name="ExpandedContent"
                      Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}"
                      Margin="0,12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- State Indicator -->
                        <Ellipse Grid.Column="0" Width="8" Height="8" Margin="0,0,10,0" VerticalAlignment="Center">
                            <Ellipse.Style>
                                <Style TargetType="Ellipse">
                                    <Setter Property="Fill" Value="#6B7280"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding State}" Value="{x:Static models:WidgetState.Listening}">
                                            <Setter Property="Fill" Value="#EF4444"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding State}" Value="{x:Static models:WidgetState.Processing}">
                                            <Setter Property="Fill" Value="#6366F1"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Ellipse.Style>
                        </Ellipse>
                        
                        <!-- Status -->
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding StatusText}" 
                                   Foreground="#FFFFFF" 
                                   FontSize="14" 
                                   FontWeight="SemiBold" 
                                   VerticalAlignment="Center"/>
                        
                        <!-- Close Button -->
                        <Button Grid.Column="2" 
                                Style="{StaticResource WidgetIconButton}" 
                                ToolTip="Close (Esc)"
                                Command="{Binding CollapseCommand}"
                                Width="24" Height="24">
                            <Path Data="M 4 4 L 12 12 M 12 4 L 4 12" 
                                  Stroke="#FFFFFF" 
                                  StrokeThickness="2"
                                  Width="10" Height="10"/>
                        </Button>
                    </Grid>
                    
                    <!-- Waveform Visualization (20 vertical bars) -->
                    <Border Grid.Row="1" 
                            Background="#18FFFFFF" 
                            CornerRadius="12" 
                            Height="70"
                            Margin="0,12"
                            ClipToBounds="True">
                        <controls:WaveformControl 
                            Amplitudes="{Binding ExpandedAmplitudes}"
                            BarCount="20"
                            BarWidth="2"
                            BarSpacing="4"
                            MaxBarHeight="25"
                            MinBarHeight="2"
                            CenterGap="4"
                            BarFill="#4EA1FF"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Width="180"
                            Height="55"/>
                    </Border>
                    
                    <!-- Footer with shortcuts -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="F2" Foreground="#FFFFFF" FontSize="11" FontWeight="Bold" Margin="0,0,4,0"/>
                        <TextBlock Text="Record" Foreground="#99FFFFFF" FontSize="11" Margin="0,0,16,0"/>
                        <TextBlock Text="Esc" Foreground="#FFFFFF" FontSize="11" FontWeight="Bold" Margin="0,0,4,0"/>
                        <TextBlock Text="Close" Foreground="#99FFFFFF" FontSize="11"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Window>
